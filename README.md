# SENSOR COLOR CORRECTION

>  Предлагается найти цветовое преобразование между цветовыми пространствами двух
камер (например, из Canon EOS-1Ds Mark III в Canon EOS 600D) полиномиальным (ан-
гл. polynomial color correction, PCC) и регрессией к взвешенным геометрическим средним
(Root-Polynomial Color Correction – RPCC) методами, т. е. найти отображение из RGB ко-
ординат одной камеры в RGB координаты другой камеры [1]. Другими словами, нужно
найти преобразование между двумя наборами изображений в виде линейного преобра-
зования не из пространства RGB, а из пространства более высокой размерности, допол-
нительные координаты в котором фиксированным нелинейным образом зависят от трех основных.

## Общий алгоритм решения задачи:

Алгоритм решения задачи цветовой калибровки между двумя камерами с использованием полиномиального цветового преобразования (PCC) и регрессии к взвешенным геометрическим средним (RPCC) может быть описан следующим образом:

1. Считывание изображений:
Загрузка изображений цветовых мишеней в формате JPEG, которые являются тестовым набором данных.
Инвертирование нелинейного преобразования (sRGB) для перехода в линейные цветовые координаты.
Считывание масок:
Загрузка файлов mask.txt, содержащих координаты квадратов цветовых мишеней на изображениях.

2. Выделение цветовых мишеней из изображений:
Используя маски, выделение областей изображений, представляющих цветовые мишени.

4. Подсчет средних значений цветовых компонент:
Вычисление средних значений красной (R), зеленой (G) и синей (B) компонент для каждого блока цветовой мишени.

5. Создание матрицы цветового преобразования:
Для PCC:
Формирование матрицы, где каждый столбец содержит исходные значения цветовых компонент и их комбинации (например, квадратные корни и произведения цветовых компонент).
Решение системы линейных уравнений методом наименьших квадратов для определения коэффициентов полинома цветового преобразования.
Для RPCC:
Формирование матрицы, где каждый столбец содержит исходные значения цветовых компонент и их комбинации, включая корни третьего порядка.
Решение системы линейных уравнений методом наименьших квадратов для определения коэффициентов полинома цветового преобразования.

6. Применение цветового преобразования к изображению:
Использование полученных коэффициентов полинома для преобразования цветовых компонент изображения.

7. Преобразование обратно в sRGB:
Применение нелинейного преобразования (обратное sRGB) для получения изображений в исходном формате.

8. Оценка качества работы моделей:
Вычисление коэффициента корреляции между цветами цветовых мишеней на сравниваемых изображениях до и после калибровки.
Сравнение корреляции до и после калибровки для оценки эффективности примененных моделей.

9. Визуализация результатов:
Построение графиков распределения значений пикселей для сравнения моделей.
Иллюстрация областей на изображениях, представляющих наибольший интерес с точки зрения сравнения моделей.




## Описание Функций:

### Функция read_image(filename):

Вход: filename - имя файла с изображением
Выход: изображение в формате numpy array
Описание: Функция считывает изображение из файла с использованием библиотеки cv2 и возвращает его в виде numpy array.

### Функция read_mask(filename):

Вход: filename - имя файла с маской
Выход: маска в формате numpy array
Описание: Функция считывает маску из файла с использованием библиотеки cv2 и возвращает ее в виде numpy array.

### Функция extract_ROI(image, mask):

Вход: image - исходное изображение, mask - маска цветовой мишени
Выход: выделенная цветовая мишень (область интереса) из исходного изображения
Описание: Функция применяет маску цветовой мишени к исходному изображению и возвращает только выделенную область.

### Функция compute_mean_color(image, polygon):

Вход: image - изображение, polygon - полигон, ограничивающий блок цветовой мишени
Выход: среднее значение цвета внутри полигона
Описание: Функция вычисляет среднее значение цвета внутри заданного полигона на изображении.

### Функция mean_matrix(image, mask, palette_blocks):

Вход: image - изображение, mask - маска цветовой мишени, palette_blocks - блоки цветовой мишени
Выход: матрица средних значений цветов для каждого блока цветовой мишени
Описание: Функция создает матрицу, где каждая строка представляет средние значения цветового блока цветовой мишени на изображении.

### Функция sRGB2lin(color):

Вход: color - цвет в sRGB пространстве
Выход: цвет в линейном пространстве
Описание: Функция преобразует цвет из sRGB пространства в линейное пространство, чтобы выполнить цветовые преобразования.

### Функция lin2sRGB(color):

Вход: color - цвет в линейном пространстве
Выход: цвет в sRGB пространстве
Описание: Функция обратно преобразует цвет из линейного пространства в sRGB пространство.

### Функция pcc(matrix1, matrix2, degree):

Вход: matrix1, matrix2 - матрицы средних значений цветов для двух изображений, degree - степень полинома для PCC
Выход: матрица цветового преобразования (PCC) заданной степени
Описание: Функция вычисляет матрицу цветового преобразования (PCC) между двумя матрицами средних значений цветов заданной степени.

### Функция apply_pcc(image, pcc_matrix):

Вход: image - изображение, pcc_matrix - матрица цветового преобразования (PCC)
Выход: скорректированное изображение
Описание: Функция применяет матрицу цветового преобразования (PCC) к изображению для выполнения цветовой коррекции.
Функция gamma2sRGB(color):

Вход: color - цвет в гамма-кодировке
Выход: цвет в sRGB пространстве
Описание: Функция преобразует цвет из гамма-кодировки в sRGB пространство.

### Функция display_images(original, corrected):

Вход: original - исходное изображение, corrected - скорректированное изображение
Выход: отображение исходного и скорректированного изображений
Описание: Функция отображает исходное и скорректированное изображения для сравнения.

### Функция correlation(image1, image2):

Вход: image1, image2 - два изображения для расчета коэффициента корреляции
Выход: коэффициент корреляции между изображениями
Описание: Функция вычисляет коэффициент корреляции между двумя изображениями для оценки эффективности цветовой коррекции.

### Эти функции совместно используются для загрузки, обработки и коррекции цветовых изображений с использованием методов PCC и RPCC.


## Описание алгоритма

Матрица преобразования в PCC (Polynomial Color Correction) вычисляется на основе средних цветовых значений блоков цветовой палитры для исходного и целевого изображений. 
Эта матрица позволяет выполнить цветовую коррекцию путем преобразования цветовых значений пикселей из одного изображения в цветовые значения пикселей другого изображения.

Процесс вычисления матрицы преобразования в PCC включает следующие шаги:

### Подготовка данных:

Исходное изображение (исходная матрица цветовых значений) обозначается как R, а целевое изображение (целевая матрица цветовых значений) обозначается как Q.
Оба изображения должны быть представлены в виде матрицы, где каждый столбец представляет среднее значение цветовых компонент (например, R, G, B) для каждого блока цветовой палитры.

### Вычисление матрицы преобразования:

Матрица преобразования M вычисляется путем решения системы линейных уравнений, где M является неизвестной матрицей, и R и Q - известными матрицами.
Система линейных уравнений обычно получается путем аппроксимации нелинейного цветового преобразования с использованием полиномиальной модели. Степень полинома определяется параметром degree, передаваемым в функцию pcc.
Для каждого блока цветовой палитры вычисляются коэффициенты полинома, которые связывают цветовые значения пикселей в исходном изображении с цветовыми значениями в целевом изображении.
Полученные коэффициенты формируют матрицу преобразования M.

Для RPCC общая реализация схожа.
PCC2: 
$Q = a_1 \cdot R + a_2 \cdot G + a_3 \cdot B + a_4 \cdot R^2 + a_5 \cdot G^2 + a_6 \cdot B^2 + a_7 \cdot R \cdot G + a_8 \cdot R \cdot B + a_9 \cdot G \cdot B$

PCC3: 
$Q = a_1 \cdot R + a_2 \cdot G + a_3 \cdot B + a_4 \cdot R^2 + a_5 \cdot G^2 + a_6 \cdot B^2 + a_7 \cdot R \cdot G + a_8 \cdot R \cdot B + a_9 \cdot G \cdot B + a_{10} \cdot R^3 + a_{11} \cdot G^3 + a_{12} \cdot B^3 $
$+ a_{13} \cdot R^2 \cdot G + a_{14} \cdot R^2 \cdot B + a_{15} \cdot G^2 \cdot R + a_{16} \cdot G^2 \cdot B + a_{17} \cdot B^2 \cdot R + a_{18} \cdot B^2 \cdot G + a_{19} \cdot R \cdot G \cdot B$

RPCC2: 
$Q = a_1 \cdot R + a_2 \cdot G + a_3 \cdot B + a_4 \cdot \sqrt{R \cdot G} + a_5 \cdot \sqrt{G \cdot B} + a_6 \cdot \sqrt{R \cdot B}$

RPCC3: 
$Q = a_1 \cdot R + a_2 \cdot G + a_3 \cdot B + a_4 \cdot \sqrt{R \cdot G} + a_5 \cdot \sqrt{G \cdot B} + a_6 \cdot \sqrt{R \cdot B} + a_7 \cdot \sqrt[3]{R \cdot G^2} + a_8 \cdot \sqrt[3]{G \cdot B^2} + a_9 \cdot \sqrt[3]{R \cdot B^2} + a_{10} \cdot \sqrt[3]{G^2 \cdot R} + a_{11} \cdot \sqrt[3]{B \cdot G^2} + a_{12} \cdot \sqrt[3]{B \cdot R^2}$

## Пример использования

Пути к файлам изображений и масок
```
canon600D = '/content/Canon600D_0003.jpg'
canon600D_m = '/content/Canon600D_0003_mask.txt'
canonDs = '/content/Canon1DsMkIII_0003.jpg'
canonDs_m = '/content/Canon1DsMkIII_0003_mask.txt'
```
Чтение изображений и масок
```
img1, mask1 = read_image(canon600D), read_mask(canon600D_m)
img2, mask2 = read_image(canonDs), read_mask(canonDs_m)
```
Преобразование цветов из sRGB в линейное пространство
```
img1_lin = sRGB2lin(img1/255)
img2_lin = sRGB2lin(img2/255)
```
  Выделение цветовой мишени из изображения
```
ROI1 = extract_ROI(img1_lin, mask1)
ROI2 = extract_ROI(img2_lin, mask2)

```
  Подсчет средних значений R, G, B для каждого блока цветовой палитры для двух изображений
```

R = mean_matrix(ROI1, mask1)
Q = mean_matrix(ROI2, mask2)
```
Вычисление матрицы цветового преобразования (PCC) для полинома 2-ой степени
```
MPCC2 = pcc(R, Q, 2)
```
Вычисление матрицы цветового преобразования (PCC) для полинома 3-ей степени
```
MPCC3 = pcc(R, Q, 3)
```
Вычисление матрицы цветового преобразования (RPCC) для рут-полинома 2-ой степени
```
MRPCC2 = rpcc(R, Q, 2)
```
Вычисление матрицы цветового преобразования (RPCC) для рут-полинома 3-ей степени
```
MRPCC3 = rpcc(R, Q, 3)
```
Вывод размеров матриц цветового преобразования
```
print(MPCC2.shape, MPCC3.shape)
print(MRPCC2.shape, MRPCC3.shape)
```
Применение матрицы цветового преобразования (PCC) к изображению с полиномом 2-ой степени
```
img_22p = apply_pcc(img2_lin, MPCC2, 2)
```
Применение матрицы цветового преобразования (PCC) к изображению с полиномом 3-ей степени
```
img_23p = apply_pcc(img2_lin, MPCC3, 3)
```
Применение матрицы цветового преобразования (RPCC) к изображению с рут-полиномом 2-ой степени
```
img_22r = apply_rpcc(img2_lin, MRPCC2, 2)
```
Применение матрицы цветового преобразования (RPCC) к изображению с рут-полиномом 3-ей степени
```
img_23r = apply_rpcc(img2_lin, MRPCC3, 3)
```
Преобразование цветов из гамма-кодировки в sRGB пространство
```
img_22p = gamma2sRGB(img_22p)
img_23p = gamma2sRGB(img_23p)
img_22r = gamma2sRGB(img_22r)
img_23r = gamma2sRGB(img_23r)
```

## Ответы на вопросы
> 1. Тестовые изображения могут отличаются не только используемой камерой, но и условиями освещения. Необходимо ответить на вопрос, делает ли это эксперимент математически некорректным и почему?

Различия в условиях освещения между тестовыми изображениями могут вносить существенные изменения в цветовые характеристики объектов, так как освещение является важным фактором в определении цвета. Цветовые пространства, такие как RGB (красный, зеленый, синий), определяются в контексте определенных условий освещения.

Если условия освещения значительно различаются между изображениями, то значения цветовых компонентов объектов могут быть смещены и искажены. Например, если освещение на одном изображении является теплым (большая преобладающая длина волны), то цвета будут иметь более теплые оттенки. В то же время, если освещение на другом изображении является холодным (меньшая преобладающая длина волны), то цвета будут иметь более холодные оттенки.

Таким образом, различия в условиях освещения могут изменять цветовые характеристики объектов и делать эксперимент математически некорректным. Для достижения точных результатов цветовой калибровки необходимо учитывать и контролировать условия освещения, чтобы обеспечить согласованность между тестовыми изображениями и минимизировать влияние освещения на цветовые характеристики объектов.


> 2. Необходимо дать оценку качеству работы моделей.

Исходя из результатов экспериментов, значительный рост корреляции между исходными и перобразованными изображениями не заметен. Но стоит учесть что в ряде работ с тестовым датасетом некоторые преобразования показали отличный визуальный результат.
В ходе работы, возникла идея о том, что реализация данной модели может быть неполноценной из-за:
1. Неправильный переход из более высокого полиномиального пространства обратно в нелинейное пространство sRGB
2. Недостаточное количество экспериментов
3. Неправильной работы с типами данных uint8 и float32

> 3. Результаты экспериментов находятся в папке Test


### Одинец Никита
